<!DOCTYPE html>
<html lang="zh">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SenseVoice WebSocket 客户端示例</title>
  <style>
    body {
      font-family: 'Microsoft YaHei', Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      line-height: 1.6;
    }

    h1 {
      color: #333;
      border-bottom: 1px solid #eee;
      padding-bottom: 10px;
    }

    .controls {
      margin: 20px 0;
      padding: 15px;
      background-color: #f5f5f5;
      border-radius: 4px;
    }

    button {
      background-color: #4CAF50;
      color: white;
      border: none;
      padding: 10px 15px;
      text-align: center;
      text-decoration: none;
      display: inline-block;
      font-size: 16px;
      margin: 5px 2px;
      cursor: pointer;
      border-radius: 4px;
    }

    button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }

    select,
    input {
      padding: 8px;
      margin: 5px 0;
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    .result {
      margin-top: 20px;
      padding: 15px;
      background-color: #f9f9f9;
      border-left: 5px solid #4CAF50;
      min-height: 100px;
    }

    #message {
      color: #666;
      font-style: italic;
    }

    #current,
    #final {
      white-space: pre-wrap;
    }

    .label {
      font-weight: bold;
      margin-right: 10px;
    }

    .info {
      margin-top: 10px;
      color: #666;
      font-size: 0.9em;
    }

    #audioStatus {
      margin-top: 10px;
      color: #666;
    }
  </style>
</head>

<body>
  <h1>SenseVoice WebSocket 流式语音识别演示</h1>

  <div class="controls">
    <div>
      <label for="language" class="label">语言选择:</label>
      <select id="language">
        <option value="auto">自动检测</option>
        <option value="zh">中文</option>
        <option value="en">英文</option>
        <option value="yue">粤语</option>
        <option value="ja">日语</option>
        <option value="ko">韩语</option>
      </select>
    </div>

    <div>
      <label for="useItn" class="label">反向文本归一化:</label>
      <input type="checkbox" id="useItn" checked>
    </div>

    <div>
      <label for="audioFile" class="label">选择音频文件:</label>
      <input type="file" id="audioFile" accept="audio/*">
    </div>

    <div>
      <button id="startButton">开始录音</button>
      <button id="stopButton" disabled>停止录音</button>
      <button id="uploadButton">上传文件识别</button>
    </div>

    <div id="audioStatus"></div>
  </div>

  <div class="result">
    <div id="message">准备就绪，请点击"开始录音"或"上传文件识别"</div>
    <div>
      <span class="label">当前识别:</span>
      <span id="current"></span>
    </div>
    <div>
      <span class="label">最终结果:</span>
      <div id="final"></div>
    </div>
  </div>

  <div class="info">
    <p>注意事项:</p>
    <ul>
      <li>录音功能需要浏览器支持WebRTC</li>
      <li>最佳音频格式为16kHz采样率的单声道WAV</li>
      <li>WebSocket连接默认设置为: <code>ws://localhost:8000/ws/recognize</code></li>
    </ul>
  </div>

  <script>
    // 配置信息
    const WS_URL = 'ws://localhost:8000/ws/recognize';
    let socket = null;
    let mediaRecorder = null;
    let audioChunks = [];
    let isRecording = false;

    // 获取DOM元素
    const startButton = document.getElementById('startButton');
    const stopButton = document.getElementById('stopButton');
    const uploadButton = document.getElementById('uploadButton');
    const audioFile = document.getElementById('audioFile');
    const languageSelect = document.getElementById('language');
    const useItnCheckbox = document.getElementById('useItn');
    const messageElement = document.getElementById('message');
    const currentElement = document.getElementById('current');
    const finalElement = document.getElementById('final');
    const audioStatus = document.getElementById('audioStatus');

    // 连接WebSocket
    function connectWebSocket() {
      messageElement.textContent = '正在连接到服务器...';

      // 创建WebSocket连接
      socket = new WebSocket(WS_URL);

      // 连接建立
      socket.onopen = function () {
        messageElement.textContent = '连接已建立，发送配置信息...';

        // 发送配置信息
        const config = {
          language: languageSelect.value,
          use_itn: useItnCheckbox.checked
        };
        socket.send(JSON.stringify(config));
      };

      // 接收消息
      socket.onmessage = function (event) {
        const data = JSON.parse(event.data);

        if (data.type === 'ready') {
          // 服务器已准备好接收音频数据
          messageElement.textContent = data.message;
        } else if (data.is_final) {
          // 最终结果
          currentElement.textContent = '';

          const resultInfo = `文本: ${data.text || ''}
语言: ${data.language || '未检测'}
情感: ${data.emotion || '未检测'}
事件: ${data.event || '未检测'}
耗时: ${data.time_cost ? data.time_cost.toFixed(2) + '秒' : '未知'}`;

          finalElement.textContent = resultInfo;
          messageElement.textContent = '识别完成';

          resetUI();
        } else {
          // 部分结果
          currentElement.textContent = data.text || '';
          messageElement.textContent = '正在识别...';
        }
      };

      // 连接关闭
      socket.onclose = function () {
        messageElement.textContent = '连接已关闭';
        resetUI();
      };

      // 连接错误
      socket.onerror = function (error) {
        messageElement.textContent = `连接错误: ${error}`;
        console.error('WebSocket错误:', error);
        resetUI();
      };
    }

    // 开始录音
    startButton.onclick = async function () {
      try {
        // 获取麦克风权限
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

        // 连接WebSocket
        connectWebSocket();

        // 创建MediaRecorder
        mediaRecorder = new MediaRecorder(stream);

        // 清空之前的数据
        audioChunks = [];
        currentElement.textContent = '';
        finalElement.textContent = '';

        // 收集录音数据
        mediaRecorder.ondataavailable = function (event) {
          if (event.data.size > 0) {
            audioChunks.push(event.data);

            // 将数据发送到WebSocket
            event.data.arrayBuffer().then(buffer => {
              if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(buffer);
              }
            });
          }
        };

        // 录音停止时的处理
        mediaRecorder.onstop = function () {
          // 发送空数据表示结束
          if (socket && socket.readyState === WebSocket.OPEN) {
            socket.send(new ArrayBuffer(0));
          }

          // 关闭麦克风
          stream.getTracks().forEach(track => track.stop());
        };

        // 更新UI
        startButton.disabled = true;
        stopButton.disabled = false;
        uploadButton.disabled = true;
        isRecording = true;

        // 每100ms获取一块数据，实现流式效果
        mediaRecorder.start(100);

        messageElement.textContent = '录音中...';
        audioStatus.textContent = '正在录音，请对着麦克风说话';

      } catch (error) {
        messageElement.textContent = `无法访问麦克风: ${error.message}`;
        console.error('录音错误:', error);
      }
    };

    // 停止录音
    stopButton.onclick = function () {
      if (mediaRecorder && isRecording) {
        mediaRecorder.stop();
        isRecording = false;

        // 更新UI
        stopButton.disabled = true;
        messageElement.textContent = '正在处理最终结果...';
        audioStatus.textContent = '录音已停止，等待识别结果';
      }
    };

    // 上传文件识别
    uploadButton.onclick = function () {
      const file = audioFile.files[0];
      if (!file) {
        messageElement.textContent = '请先选择一个音频文件';
        return;
      }

      // 连接WebSocket
      connectWebSocket();

      // 更新UI
      startButton.disabled = true;
      uploadButton.disabled = true;

      // 读取文件
      const reader = new FileReader();

      reader.onload = function (e) {
        const arrayBuffer = e.target.result;

        // 将文件分块发送
        const CHUNK_SIZE = 16000; // 约1秒的16kHz音频

        function sendNextChunk(start) {
          if (start >= arrayBuffer.byteLength) {
            // 发送空数据表示结束
            if (socket && socket.readyState === WebSocket.OPEN) {
              socket.send(new ArrayBuffer(0));
            }
            return;
          }

          const end = Math.min(start + CHUNK_SIZE, arrayBuffer.byteLength);
          const chunk = arrayBuffer.slice(start, end);

          if (socket && socket.readyState === WebSocket.OPEN) {
            socket.send(chunk);

            // 模拟实时发送
            setTimeout(() => sendNextChunk(end), 100);

            const progress = Math.round((end / arrayBuffer.byteLength) * 100);
            audioStatus.textContent = `正在发送音频: ${progress}%`;
          }
        }

        // 开始分块发送
        sendNextChunk(0);
      };

      reader.onerror = function (error) {
        messageElement.textContent = `文件读取错误: ${error}`;
        resetUI();
      };

      // 读取文件内容
      reader.readAsArrayBuffer(file);
      messageElement.textContent = '正在读取文件...';
    };

    // 重置UI状态
    function resetUI() {
      startButton.disabled = false;
      stopButton.disabled = true;
      uploadButton.disabled = false;
      isRecording = false;
      audioStatus.textContent = '';

      // 如果录音还在进行，停止它
      if (mediaRecorder && mediaRecorder.state === 'recording') {
        mediaRecorder.stop();
      }

      // 关闭WebSocket
      if (socket) {
        socket.close();
        socket = null;
      }
    }

    // 页面加载完成后初始化
    window.onload = function () {
      resetUI();
    };
  </script>
</body>

</html>